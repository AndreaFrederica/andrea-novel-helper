# Change Log

## [0.0.20] - 2025-08-16
### 🔥 重大：字数统计视图升级为“写作专用资源管理器”
Word Count Explorer（字数统计视图）现可在写作时直接替代 VS Code 原生 Explorer：
- **拖拽排序与重排**：同一目录内拖拽即为“顺序调整”（不移动文件物理位置，手动模式下保持稳定；自动模式可提示切换手动）。
- **跨目录拖拽移动**：不同父目录之间拖拽 = 真实文件/文件夹物理迁移，并自动更新追踪索引。
- **手动 / 自动排序模式**：支持目录级别切换；手动模式下使用稀疏索引（默认步长配置），保证插入时最少重排；自动模式按文件名或创建顺序自然排序。
- **索引显示与格式**：可选择在标签前显示排序索引，支持步长 (step) 与填充宽度 (padWidth) 配置，自动衰减 / 自动重排 (autoResequence)。
- **快速批量索引生成**：提供基于文件名批量生成或清除索引的命令，便于一次性整理章节结构。
- **复制 / 剪切 / 粘贴**：视图内支持多选复制/剪切再粘贴（含跨目录），保持元数据与追踪一致性。
- **显示格式增强**：新增字数显示格式配置（raw / wan / k / qian），更易于在长篇工程中阅读。
- **忽略规则集成**：继续支持 `.gitignore` / `.wcignore` 过滤无关文件，视图更聚焦。

### ✨ 其他新增
- **包管理器拖拽增强**：支持资源文件与包结构的拖拽复制/移动，与字数统计视图交互体验一致。
- **分片文件追踪数据库 (Sharded DB)**：引入 `.anh-fsdb` 分片 + 索引增量写入，减少大项目 IO。
- **惰性索引加载**：启动仅加载 `index.json`，按需加载分片。
- **大纲惰性模式**：`AndreaNovelHelper.outline.lazyMode` 默认开启，未开大纲视图不生成文件。
- **写作统计只读会话抑制**：`timeStats.persistReadOnlySessions=false` 下纯阅读不落盘。
- **脏分片原因日志**：`markShardDirty` 输出触发源（新增/重命名/内容/统计等）。
- **Legacy 快照开关**：`fileTracker.writeLegacySnapshot` 控制是否写出旧版聚合 JSON。

### 🛠️ 优化
- 防止“仅打开文件”即写入：哈希/size/mtime/统计差异严格对比才标记脏。
- 写作统计 diff 字段可见：日志输出具体变化字段集合。
- 纯 lastActiveTime 变化被抑制，不写入分片。
- **字数统计性能**：引入缓存与异步刷新管线（延迟/批量处理），显著降低大工作区扫描与重复计算的阻塞时间。

### ⚠️ 可能影响
- 若依赖旧 `file-tracking.json` ，需开启 `writeLegacySnapshot` 维持兼容。
- 手动模式依赖稀疏索引策略，外部手动改文件名可能导致相对顺序变化需手动“重建索引”。

### 🧪 后续计划
- Index.json 增量写（当前为整体重写）。
- 分离大字段到二级分片（写作桶 / 会话）。
- 更细粒度的写作统计节流与压缩策略。


## [0.0.19] - 2025-08-14
### ✨ 新增
- **写作时间追踪**：新增写作时间追踪功能，提供实时的写作速度统计（CPM）
- **写作统计仪表板**：新增写作统计仪表板，今日和历史的写作时间、平均速度和峰值速度统计,活跃度统计
- **正则表达式着色**：支持使用正则表达式为文本着色，提供更灵活的样式应用（比如说着色各种标点符号框起来的字符）

## [0.0.18] - 2025-08-14
### 🐛 修复
- 修复了包管理器视图中的右键菜单选项，确保在资源文件和包上正确显示

## [0.0.17] - 2025-08-14
### 🐛 修复
- 修复了展开状态无法正确恢复的问题
- 修复了Hover里的图片无法正确显示的问题

### ✨ 新增
- 新增状态持久化功能，支持记住文件树的展开状态
- 新增包管理器内的资源文件支持
- 强化了对Markdown格式设定集的支持，支持自定义段

## [0.0.16] - 2025-08-14
### 🐛 修复
- Markdown格式设定集下面的颜色支持（现在支持更多格式）

## [0.0.15] - 2025-08-14
### ✨ 新增
- 新增快速格式化工具，支持在Markdown文件中快速应用常用格式

## [0.0.14] - 2025-08-14
### 🐛 修复
- 修复了在某些情况下无法正确打开文件的问题
- 修复了大纲不能在启动时自动加载的问题
### ✨ 新增
- 新增命令 `AndreaNovelHelper.revealInExplorer`，用于在系统文件资源管理器中显示文件
- 在包管理器视图中添加了“在文件资源管理器中显示”选项，方便快速定位文件
- 实现了包管理器，允许用户创建、重命名和删除设定集（包）
- .wcignore 文件支持，允许用户指定不进行字数统计的文件和目录
- .gitignore 文件支持，自动忽略 Git 忽略的文件和目录的字数统计
- md格式的角色库、敏感词库、词汇库支持
### 🛠️ 重构
- 重构字数统计功能，提升性能和稳定性
- Roles的加载逻辑，允许使用嵌套的包结构

## [0.0.12] - 2025-07-24
### 🐛 修复
- 修复了HoverProvider在某些情况下无法正确更新的问题
- 修复了多文件下的Hover信息缓存问题，确保每个文件的Hover信息独立管理
- 修复了多文件下DefinitionProvider无法正确跳转到定义的问题
### 🛠️ 重构
- 重构了HoverProvider的增量刷新逻辑，优化性能
- 优化了Hover信息的缓存机制，减少不必要的计算（但是目前仍然存在性能问题，后续会继续优化）
- 重构了DefinitionProvider的跳转逻辑，确保在多文件环境下正确工作（现在依赖于HoverProvider的缓存）
### ✨ 新增
- 实验性大纲功能，支持在Markdown和文本文件中显示大纲
- 新增命令 `AndreaNovelHelper.openDoubleOutline`，用于打开双重大纲视图
- 在支持的编辑器中添加了大纲按钮，点击可打开大纲视图
### ⚠️ 问题
- 大纲窗体在Code刚启动的时候不能正常显示 目前也不会自动刷新


## [0.0.11] - 2025-07-23

### 🐛 修复

- 项目结构重构
- 极大的优化了词汇装饰器的性能

## [0.0.10] - 2025-07-22

### 🐛 修复

- 修复了敏感词警告在删除敏感词后仍然显示的问题

## [0.0.9] - 2025-07-22

### ✨ 新增

- 新增敏感词和词汇功能，更新相关配置和命令
- 更新配置文件路径，确保默认路径正确
- 修复了角色库文件路径的默认值，请手动更新配置文件

### 🐛 修复

- 修复了非资源管理器面板打开文件强制重定向到资源管理器的问题

## [0.0.8] - 2025-07-21

### ✨ 新增

- 新增实验性字数统计功能，提供对工作区内所有支持文件的字数统计

## [0.0.7] - 2025-07-20

### 🐛 修复

- 添加了图标

## [0.0.6] - 2025-07-20

### 🛠️ 重构

- 重构装饰更新逻辑，独立 `updateDecorations` 函数
- 优化工具函数，添加区间重叠检查和正则转义功能
- 现在能避免 `hoverRanges` 区间重复的问题
- 修复了角色信息窗口不能显示颜色的 bug

## [0.0.5] - 2025-07-19

### ✨ 新增

- 增加 CSpell 字典生成，支持角色名拼写检查

## [0.0.4] - 2025-07-19

### 🐛 修复

- 修复了补全提供器无法动态响应的问题

---

## [0.0.2] - 2025-07-19

### ✨ 新增

- 支持多语言（i18n），添加中文语言包
- 新增角色类型功能，支持根据类型应用默认颜色样式

---

## [0.0.1] - 2025-07-18

### 🎉 初始版本

#### ✨ 功能

- 实现基础的 JSON5 角色库加载、分词补全与着色
- 添加角色别名支持，补全和着色均支持主名与别名
- 实现角色的跳转功能（Go to Definition）：支持 `F12` / `Ctrl+Click`
- 引入 `HoverProvider`，显示角色简介、类型、从属关系和颜色预览
- 右键菜单：新增命令 “Create Role from Selection”，可交互式创建新角色
- 文件变更监听：角色库文件保存后自动刷新补全和语法高亮
- 使用 `Intl.Segmenter` 实现中文分词，兼容多语言场景

#### 🧠 优化

- 优化补全排序逻辑，前缀匹配的候选项优先显示

---

## 🚧 已知问题

- ❗ 中文分词仍不稳定，某些词（如“睡觉”）会误识别部分字符（如“觉”）为角色
- ❗ 当角色名之间存在包含关系时，着色可能不准确
- ❗ 当前无 UUID 支持，角色名称需手动保证唯一
- ❗ 暂不支持“角色关系”建模，未来可能参考数据库关系结构添加
- ❗ 角色类型尚未开放自定义，计划后续支持用户自定义类型与颜色映射
