# Change Log

## [0.3.20] - 2025-08-27
### 🐛 修复
- 修改了读取数据库的逻辑 性能得到提升 但是依旧存在两次全量读取的问题
- 修复了从预览窗口回到编辑器窗口的时候Session被截断的问题
- 修改TimeState的获取全文件统计为异步方式，有性能提升
- 修复了HoverProvider的边界条件，避免某些时候扩展卡死
### ✨ 新增
- 新增了对小地图（Minimap）和Ctrl+滚轮快速缩放字体的支持（快速设置）
- 版式状态栏支持以简略模式显示
- 改进了滚动模式下的预览编辑时动态刷新问题
### ⚠️ 问题
- 分页预览模式下的动态刷新有问题，需要手动刷新，后续会优化


## [0.3.19] - 2025-08-26
### 🐛 修复
- 恢复了GitGuard功能，但是字数统计缓存速度仍然有点慢，考虑加入固实数据库支持

## [0.3.18] - 2025-08-26
### 🐛 修复
- 修复了一点击写作统计面板，就丢失写作统计焦点的问题
- 修复了一点预览面板，就丢失写作统计焦点的问题
- 修复了预览的重载机制，现在不会乱动布局了
### 🖋️ 更改
- 修改周视图为可变的滑窗
- 微调字数统计器的逻辑，略微优化性能
- 修改了状态栏的时间统计逻辑，现在会读秒了
### ⚠️ 问题
- 切换预览界面等界面后冲刷掉当前session的bug仍没修复
- 初始化的时候字数统计器依然有同步占用主线程嫌疑（虽然已经并行处理（可能是调用了node的fileio 不清楚怎么解决这个问题）

## [0.3.17] - 2025-08-26
### 🐛 修复
- 修复了上个版本损坏的字数统计器

## [0.3.16] - 2025-08-25
### 🐛 修复
- 修复了对包管理器里面内容的边界判定
- 修复了角色卡编辑器的换行效果

## [0.3.12] - 2025-08-25
### 🐛 修复
- 修复了着色器偶发失效（修正了状态校验边界问题）
### ✨ 新增
- 新增了可视化角色卡编辑器
- 新增了切换Json5格式角色库的默认打开编辑器开关
- 支持了角色卡编辑器的一键转跳定义
### ⚠️ 问题
- 角色卡编辑器目前只支持light和dark两种主题，其他主题可能会有显示问题，后续会继续优化
- link.tooltip 会丢参数 很怪

## [0.3.11] - 2025-08-23
### 🐛 修复
- 修复了设置字体的时候的错误格式问题

## [0.3.10] - 2025-08-23
### 🐛 修复
- 修复了上个版本遗漏的i18n缺失问题

## [0.3.9] - 2025-08-23
### 🐛 修复
- 修复了着色器偶发失效（修正了缓存错误）
- 修复了txt的预览不能分页的问题
### ✨ 新增
- 新增了智慧回车功能
- 新增了智慧括号功能
- 新增了版式设置
- 新增了字体家族可视化编辑器
- 新增了文章格式化工具
- 新增了编辑器区和写作资源管理器区的快速导出txt和纯文本功能（右键）


## [0.3.8] - 2025-08-22
### 🐛 修复
- 修复了预览窗体的分页错误
- 修复了预览窗体的预设无法保存问题
### ✨ 新增
- 新增了对预览窗体的主题支持
- 新增了对预览窗体的字体设置支持
### 🛠️ 优化 / 重构
- 预览窗体Webview重构 优化了项目结构

## [0.3.7] - 2025-08-21
### 🐛 修复
- 修复了上次重构导致的Worker崩溃问题
- 修复了fixes类型不生效的问题

## [0.3.6] - 2025-08-20
### 🐛 修复
- 修复了文件追踪器过滤器规则问题
### ✨ 新增
- 新增对文件追踪器的信任调用者过滤器配置
- 新增了是否在工作区关闭小说助手的配置选项询问（`AndreaNovelHelper.enableWorkspaceClose`）

## [0.3.5] - 2025-08-19
### 📃 预览和读稿器（实验性）
- 优化读稿器的使用体验

## [0.3.4] - 2025-08-19
### 🧭 项目初始化体验
- 向导整合：写作统计数据库纳入/忽略 + 多目录（.history / .vscode / .out-of-code-insights）忽略一站式选择，默认推荐策略，减少后期手工编辑。
### ✨ 包管理器
- 新增右键创建 TXT 快速导入文件：角色 / 敏感词 / 词汇（可自定义文件名，默认建议 `character-gallery.txt` 等）。
### 📝 TXT 解析改进
- 允许行级注释：支持整行 `#` / `//` 开头与行内尾部注释（`名称 # 注释`）。
- 空行与注释不计入条目数，日志显示有效条目数量。
### 📃 预览和读稿器（实验性）
- 新增预览和读稿器功能，支持在侧边栏中预览文档内容。
- 支持多种文档格式的预览，包括 Markdown、TXT 等。
### 🧹 其它
- 清理已弃用的版本控制配置项 UI，统一放入初始化流程中决策。


## [0.3.3] - 2025-08-18
### ♻️ 创建命令整合
- 角色 / 敏感词 / 词汇 创建命令统一为各 1 项，内部可选生成格式：json5 / txt / md，减少右键菜单噪音。
- 新建时检测重名：若存在冲突自动追加 `_YYYYMMDD_HHmmss`（必要时再递增索引）。
- 输入留空时使用规范默认文件名 (character-gallery / sensitive-words / vocabulary)。
### 📝 模板
- 敏感词 / 角色 / 词汇 支持 Markdown 模板（敏感词库使用内置 md 模板）。
### ✨ 体验
- 新建文件后自动打开。
- 支持敏感词踢替换和别名替换。
### ⚡ 字数统计
- 强制重算（全部 / 指定路径）改为后台批处理异步 Worker 接口：不再长时间“计算中”卡住，目录旧值会旋转指示并逐批更新。
- 旧同步接口与冗余导入移除，避免阻塞。
- 目录聚合改为“子完成 -> 父级链式信号”事件驱动：仅受影响链路逐层重算，取消旧的向上整链失效 + 定期刷新策略，减少抖动。


## [0.3.2] - 2025-08-18
### ✨ 新增
- 修改md和plaintext的默认快速建议设置
- 微调角色加载器行为
- 微调着色器行为
### ⚡ 核心性能 & 体验
- WordCount现在在后台Worker运行 并且并行化 极大的加速了。

## [0.3.1] - 2025-08-18
### ✨ 新增

## [0.3.5] - 2025-08-18
### 🧭 项目初始化体验
- 向导整合：写作统计数据库纳入/忽略 + 多目录（.history / .vscode / .out-of-code-insights）忽略一站式选择，默认推荐策略，减少后期手工编辑。
### ✨ 包管理器
- 新增右键创建 TXT 快速导入文件：角色 / 敏感词 / 词汇（可自定义文件名，默认建议 `character-gallery.txt` 等）。
### 📝 TXT 解析改进
- 允许行级注释：支持整行 `#` / `//` 开头与行内尾部注释（`名称 # 注释`）。
- 空行与注释不计入条目数，日志显示有效条目数量。
### 🧹 其它
- 清理已弃用的版本控制配置项 UI，统一放入初始化流程中决策。

## [0.3.4] - 2025-08-18
### ✨ 新增
- 初始化向导新增“忽略辅助目录”多选：`.history/` (写入 .gitignore)、`.vscode/` 与 `.out-of-code-insights/` (划词注解扩展数据目录，写入 .wcignore)，默认全部勾选，减少无意义扫描/统计。
### ⚙️ 变更
- 保留写作统计数据库（.anh-fsdb）是否纳入版本控制的单独询问；与上述新选项统一放在向导里。

## [0.3.3] - 2025-08-18
### ⚙️ 变更
- 移除设置面板项 `AndreaNovelHelper.fileTracker.versionControlWritingStats`：该决策仅在项目初始化向导里询问与应用，避免用户误以为运行期切换会自动修改 .gitignore。

### 🐛 修复
修复了仓促异步化造成的各种严重问题
- 修复了Def在json5里不工作的问题
- 修复了补全器里面颜色不显示的问题
- 修复着色器拖尾的问题
- 修复了别名不着色的问题
- 修复了补全失效的问题
- 修复了当前文章角色有时候刷新不出来的问题
- 修复了着色器有时候失效的问题
- 修正了在敏感词库里还报敏感词的问题

## [0.2.24] - 2025-08-17
### 🐛 修复
- 没有描述文件的时候 角色加载中… 不消失的问题
- 修正了很久没有变动的语义化版本号

## [0.0.23] - 2025-08-17
聚焦“性能与准确性”版本（无新增大功能），围绕异步匹配、装饰刷新、目录 / 字数聚合与分词过滤进行了系统性优化。

### ⚡ 核心性能 & 体验
- 角色 / 词汇匹配全面迁移至共享 Worker（Aho-Corasick）异步执行：主线程不再被大文本扫描阻塞。
- 装饰更新：延迟获取全文 + 正则扫描分片切片（time-slicing），减少 >5ms 长帧；增量 setDecorations 仅更新差异区间。
- 巨型文件防护：统一 hugeFile 阈值下（估算长度 *1.8）关闭高成本特性（着色 / Hover / 角色模型 / 树索引搜索）并一次性提示。
- 文档角色模型（当前文章角色视图）异步化：首次 + 后续刷新均不再卡顿；结果缓存复用两处视图。
- 字数统计 Tree 目录聚合：批处理 + 协作式调度（yield）+ 大文件快速近似值（显示 ≈），后台再精确修正。
- 目录聚合缓存命中与失效策略优化，避免重复全量遍历；旧值占位减少 UI 闪烁。

### 🎯 匹配准确性 & 分词过滤
- 引入异步 Aho-Corasick 匹配（首次发布即包含分词边界校验支持），减少主线程阻塞。
- 支持分词过滤配置：
	- `AndreaNovelHelper.enableWordSegmentFilter` 全局开关。
	- `AndreaNovelHelper.wordSegment.autoFilterMaxLength`（默认 1）：短词（≤阈值）使用 Intl.Segmenter 进行“完整词”校验，避免单字/短词内嵌误匹配。
- 规则：若未显式设置 `wordSegmentFilter:false`，则按长度阈值自动决定是否执行分词验证；仅完整词段位置被接受。

### 🛠 内部重构与稳定性
- Worker 构建等待队列（build waiters）确保搜索不会在未完成构建时返回空结果误判。
- 搜索超时（5s）保护与错误透传，避免悬挂 Promise。
- 增强重建触发：监听分词相关配置变更实时重建自动机。
- 角色匹配缓存版本化：避免旧结果与新文档版本交叉污染。
- 代码统一加括号 / NFC 归一化，减少边界大小写与 Unicode 组合差异。

### � 调试 / 日志
- 新增多类标签日志：异步匹配、目录聚合、巨大文件判定、正则切片批次，用于性能回溯。


### ⚠️ 可能影响
- 短词（≤ autoFilterMaxLength）默认走分词完整词校验；若需要更宽松的匹配，可调低阈值或关闭分词过滤。

### 🔮 后续展望（不含于本次）
- 角色出现次数排序 / 快速过滤。
- 增量 AC 动态添加 / 移除模式（避免全量重建）。
- 更细粒度的 Hover 渲染延迟与并发调度。

---

---

## [0.0.22] - 2025-08-17
### 🐛 核心修复
- 目录字数始终为 0：删除旧的“父级增量累加”方案，改为实时递归聚合，首次/缓存命中后均能正确展示目录总字数。
- 手动排序显示异常：根因是旧版排序键仍使用 `p:` 路径键且未正确迁移/补全生成对应 `f:`/`d:` 结构化键，读取时产生索引与实际节点错位；已加入统一迁移 (p:→f:/d:) 与缺失自动生成逻辑，排序稳定。
- 父级双重累加导致目录数字虚高：移除重复叠加逻辑 (`updateParentFolderCaches`)；统计结果与文件总和一致。
- 删除 / 重命名 后目录统计不刷新或残留旧值：新增删除、重命名事件处理，迁移或失效相关缓存。
- 保存文件后父目录不更新或闪烁为 0：统一向上失效策略并提供旧值保留，避免瞬时 0。
- 并发展开 / 多次触发导致重复深度遍历：加入并发去重（同一路径聚合复用同一 Promise）。

### 🛠️ 优化
- 聚合缓存策略：仅在内容 / 结构变化或显式强制时失效；去除中途尝试过的 TTL 机制（避免无谓周期重算）。
- 旧值保留：有历史聚合时重算阶段显示旧数字 + 旋转图标；仅第一次出现“(计算中...)”。
- 根级强制刷新：`强制全部重算` 只标记根目录，递归一次完成，避免对所有文件逐个打标。
- 保存复用实时统计：优先使用 `timeStats` 已得出的全文统计，减少重复 IO。
- 强化调试：增加 `dirAggCache:hit / update / invalidate / forced-recompute / reuse-inflight` 等日志标签，定位缓存行为。
- 手动排序启用逻辑调整：启用前先获取“当前自动模式”下的可见顺序快照，并按该顺序为所有子项重新生成连续稀疏索引（10,20,...）；关闭手动模式仅移除目录手动标记，不清除已生成索引，重新开启后顺序可直接恢复。

### ⚙️ 内部
- 新增 `previousDirAggCache`：失效后在新结果出炉前展示旧值，减少 UI 抖动。

---

## [0.0.21] - 2025-08-16
### ✨ 新增
- 角色层级树（`角色` 视图）：按【从属(affiliation) → 类型(type) → 角色】三级分组，特殊类型（词汇 / 敏感词 / 正则表达式）独立收纳并置底显示，内部保持从属 + 类型分层。
- “当前文章角色” 双入口：在插件自定义侧边栏与资源管理器 (Explorer) 各提供一个独立 Tree View，实时展示当前活动文档出现过的角色列表。
- 展开状态持久化：`角色` / `当前文章角色`（侧边栏）/ `当前文章角色`（Explorer）三处视图的展开折叠状态保存到 workspaceState，重启后自动恢复。

### 🛠️ 优化 / 重构
- 共享文档角色缓存模型 (`docRolesModel`)：集中进行 Aho-Corasick 搜索与分组缓存，两处“当前文章角色”视图复用结果，避免重复扫描。
- 角色节点 ID 体系增强：为主角色树节点生成结构化 baseId + 递增去重后缀 (`::N`)，彻底消除重复 ID 报错，展开状态持久化稳定性提升。
- 文档角色刷新防抖：编辑频繁场景合并为 120ms 内一次刷新，减轻 UI 抖动与性能消耗。

### 🐛 修复
- 修复偶发“ID 为 role:... 已被注册”错误（TreeItem 重复 ID）。

### ⚙️ 内部
- 抽离重复的文档角色构建逻辑，降低维护成本，为后续扩展（出现次数、过滤）打基础。

### 🔮 规划中（尚未实现）
- 角色出现次数统计 / 排序。 
- 文档角色快速过滤（输入关键字筛选）。
- 更精确的角色定义定位（基于预索引位置）。

---

## [0.0.20] - 2025-08-16
### 🔥 重大：字数统计视图升级为“写作专用资源管理器”
Word Count Explorer（字数统计视图）现可在写作时直接替代 VS Code 原生 Explorer：
- **拖拽排序与重排**：同一目录内拖拽即为“顺序调整”（不移动文件物理位置，手动模式下保持稳定；自动模式可提示切换手动）。
- **跨目录拖拽移动**：不同父目录之间拖拽 = 真实文件/文件夹物理迁移，并自动更新追踪索引。
- **手动 / 自动排序模式**：支持目录级别切换；手动模式下使用稀疏索引（默认步长配置），保证插入时最少重排；自动模式按文件名或创建顺序自然排序。
- **索引显示与格式**：可选择在标签前显示排序索引，支持步长 (step) 与填充宽度 (padWidth) 配置，自动衰减 / 自动重排 (autoResequence)。
- **快速批量索引生成**：提供基于文件名批量生成或清除索引的命令，便于一次性整理章节结构。
- **复制 / 剪切 / 粘贴**：视图内支持多选复制/剪切再粘贴（含跨目录），保持元数据与追踪一致性。
- **显示格式增强**：新增字数显示格式配置（raw / wan / k / qian），更易于在长篇工程中阅读。
- **忽略规则集成**：继续支持 `.gitignore` / `.wcignore` 过滤无关文件，视图更聚焦。

### ✨ 其他新增
- **包管理器拖拽增强**：支持资源文件与包结构的拖拽复制/移动，与字数统计视图交互体验一致。
- **分片文件追踪数据库 (Sharded DB)**：引入 `.anh-fsdb` 分片 + 索引增量写入，减少大项目 IO。
- **惰性索引加载**：启动仅加载 `index.json`，按需加载分片。
- **大纲惰性模式**：`AndreaNovelHelper.outline.lazyMode` 默认开启，未开大纲视图不生成文件。
- **写作统计只读会话抑制**：`timeStats.persistReadOnlySessions=false` 下纯阅读不落盘。
- **脏分片原因日志**：`markShardDirty` 输出触发源（新增/重命名/内容/统计等）。
- **Legacy 快照开关**：`fileTracker.writeLegacySnapshot` 控制是否写出旧版聚合 JSON。

### 🛠️ 优化
- 防止“仅打开文件”即写入：哈希/size/mtime/统计差异严格对比才标记脏。
- 写作统计 diff 字段可见：日志输出具体变化字段集合。
- 纯 lastActiveTime 变化被抑制，不写入分片。
- **字数统计性能**：引入缓存与异步刷新管线（延迟/批量处理），显著降低大工作区扫描与重复计算的阻塞时间。

### ⚠️ 可能影响
- 若依赖旧 `file-tracking.json` ，需开启 `writeLegacySnapshot` 维持兼容。
- 手动模式依赖稀疏索引策略，外部手动改文件名可能导致相对顺序变化需手动“重建索引”。

### 🧪 后续计划
- Index.json 增量写（当前为整体重写）。
- 分离大字段到二级分片（写作桶 / 会话）。
- 更细粒度的写作统计节流与压缩策略。


## [0.0.19] - 2025-08-14
### ✨ 新增
- **写作时间追踪**：新增写作时间追踪功能，提供实时的写作速度统计（CPM）
- **写作统计仪表板**：新增写作统计仪表板，今日和历史的写作时间、平均速度和峰值速度统计,活跃度统计
- **正则表达式着色**：支持使用正则表达式为文本着色，提供更灵活的样式应用（比如说着色各种标点符号框起来的字符）

## [0.0.18] - 2025-08-14
### 🐛 修复
- 修复了包管理器视图中的右键菜单选项，确保在资源文件和包上正确显示

## [0.0.17] - 2025-08-14
### 🐛 修复
- 修复了展开状态无法正确恢复的问题
- 修复了Hover里的图片无法正确显示的问题

### ✨ 新增
- 新增状态持久化功能，支持记住文件树的展开状态
- 新增包管理器内的资源文件支持
- 强化了对Markdown格式设定集的支持，支持自定义段

## [0.0.16] - 2025-08-14
### 🐛 修复
- Markdown格式设定集下面的颜色支持（现在支持更多格式）

## [0.0.15] - 2025-08-14
### ✨ 新增
- 新增快速格式化工具，支持在Markdown文件中快速应用常用格式

## [0.0.14] - 2025-08-14
### 🐛 修复
- 修复了在某些情况下无法正确打开文件的问题
- 修复了大纲不能在启动时自动加载的问题
### ✨ 新增
- 新增命令 `AndreaNovelHelper.revealInExplorer`，用于在系统文件资源管理器中显示文件
- 在包管理器视图中添加了“在文件资源管理器中显示”选项，方便快速定位文件
- 实现了包管理器，允许用户创建、重命名和删除设定集（包）
- .wcignore 文件支持，允许用户指定不进行字数统计的文件和目录
- .gitignore 文件支持，自动忽略 Git 忽略的文件和目录的字数统计
- md格式的角色库、敏感词库、词汇库支持
### 🛠️ 重构
- 重构字数统计功能，提升性能和稳定性
- Roles的加载逻辑，允许使用嵌套的包结构

## [0.0.12] - 2025-07-24
### 🐛 修复
- 修复了HoverProvider在某些情况下无法正确更新的问题
- 修复了多文件下的Hover信息缓存问题，确保每个文件的Hover信息独立管理
- 修复了多文件下DefinitionProvider无法正确跳转到定义的问题
### 🛠️ 重构
- 重构了HoverProvider的增量刷新逻辑，优化性能
- 优化了Hover信息的缓存机制，减少不必要的计算（但是目前仍然存在性能问题，后续会继续优化）
- 重构了DefinitionProvider的跳转逻辑，确保在多文件环境下正确工作（现在依赖于HoverProvider的缓存）
### ✨ 新增
- 实验性大纲功能，支持在Markdown和文本文件中显示大纲
- 新增命令 `AndreaNovelHelper.openDoubleOutline`，用于打开双重大纲视图
- 在支持的编辑器中添加了大纲按钮，点击可打开大纲视图
### ⚠️ 问题
- 大纲窗体在Code刚启动的时候不能正常显示 目前也不会自动刷新


## [0.0.11] - 2025-07-23

### 🐛 修复

- 项目结构重构
- 极大的优化了词汇装饰器的性能

## [0.0.10] - 2025-07-22

### 🐛 修复

- 修复了敏感词警告在删除敏感词后仍然显示的问题

## [0.0.9] - 2025-07-22

### ✨ 新增

- 新增敏感词和词汇功能，更新相关配置和命令
- 更新配置文件路径，确保默认路径正确
- 修复了角色库文件路径的默认值，请手动更新配置文件

### 🐛 修复

- 修复了非资源管理器面板打开文件强制重定向到资源管理器的问题

## [0.0.8] - 2025-07-21

### ✨ 新增

- 新增实验性字数统计功能，提供对工作区内所有支持文件的字数统计

## [0.0.7] - 2025-07-20

### 🐛 修复

- 添加了图标

## [0.0.6] - 2025-07-20

### 🛠️ 重构

- 重构装饰更新逻辑，独立 `updateDecorations` 函数
- 优化工具函数，添加区间重叠检查和正则转义功能
- 现在能避免 `hoverRanges` 区间重复的问题
- 修复了角色信息窗口不能显示颜色的 bug

## [0.0.5] - 2025-07-19

### ✨ 新增

- 增加 CSpell 字典生成，支持角色名拼写检查

## [0.0.4] - 2025-07-19

### 🐛 修复

- 修复了补全提供器无法动态响应的问题

---

## [0.0.2] - 2025-07-19

### ✨ 新增

- 支持多语言（i18n），添加中文语言包
- 新增角色类型功能，支持根据类型应用默认颜色样式

---

## [0.0.1] - 2025-07-18

### 🎉 初始版本

#### ✨ 功能

- 实现基础的 JSON5 角色库加载、分词补全与着色
- 添加角色别名支持，补全和着色均支持主名与别名
- 实现角色的跳转功能（Go to Definition）：支持 `F12` / `Ctrl+Click`
- 引入 `HoverProvider`，显示角色简介、类型、从属关系和颜色预览
- 右键菜单：新增命令 “Create Role from Selection”，可交互式创建新角色
- 文件变更监听：角色库文件保存后自动刷新补全和语法高亮
- 使用 `Intl.Segmenter` 实现中文分词，兼容多语言场景

#### 🧠 优化

- 优化补全排序逻辑，前缀匹配的候选项优先显示

---

## 🚧 已知问题

- ❗ 中文分词仍不稳定，某些词（如“睡觉”）会误识别部分字符（如“觉”）为角色
- ❗ 当角色名之间存在包含关系时，着色可能不准确
- ❗ 当前无 UUID 支持，角色名称需手动保证唯一
- ❗ 暂不支持“角色关系”建模，未来可能参考数据库关系结构添加
- ❗ 角色类型尚未开放自定义，计划后续支持用户自定义类型与颜色映射
